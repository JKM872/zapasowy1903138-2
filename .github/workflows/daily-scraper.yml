name: Daily Sports Scraper

on:
  schedule:
    # Uruchomienie o 2:00 UTC (3:00 czasu polskiego zimÄ…, 4:00 latem)
    # KaÅ¼dy sport osobno z 5-minutowymi przerwami dla stabilnoÅ›ci
    - cron: '0 2 * * *'   # Football o 2:00
    - cron: '5 2 * * *'   # Basketball o 2:05
    - cron: '10 2 * * *'  # Tennis o 2:10
    - cron: '15 2 * * *'  # Hockey o 2:15
    - cron: '20 2 * * *'  # Volleyball o 2:20
    - cron: '25 2 * * *'  # Handball o 2:25
  
  workflow_dispatch:
    inputs:
      sport:
        description: 'Sport to scrape (football, basketball, tennis, hockey, volleyball, handball, all)'
        required: true
        default: 'all'
        type: choice
        options:
          - football
          - basketball
          - tennis
          - hockey
          - volleyball
          - handball
          - all
      date:
        description: 'Date to scrape (YYYY-MM-DD format, empty for today)'
        required: false
        default: ''
      use_forebet:
        description: 'Use Forebet predictions'
        required: false
        default: true
        type: boolean
      use_sofascore:
        description: 'Use SofaScore fan votes'
        required: false
        default: true
        type: boolean
      use_odds:
        description: 'Fetch FlashScore odds'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  # Chrome/Selenium stability settings for CI/CD
  SELENIUM_TIMEOUT: '180'
  CHROME_HEADLESS: 'new'
  PYTHONUNBUFFERED: '1'

jobs:
  determine-sport:
    runs-on: ubuntu-latest
    outputs:
      sport: ${{ steps.set-sport.outputs.sport }}
      date: ${{ steps.set-date.outputs.date }}
    steps:
      - name: Determine which sport to scrape
        id: set-sport
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "sport=${{ github.event.inputs.sport }}" >> $GITHUB_OUTPUT
          else
            # Scheduled run - determine sport by cron minute
            MINUTE=$(date -u +%M)
            case $MINUTE in
              00) echo "sport=football" >> $GITHUB_OUTPUT ;;
              05) echo "sport=basketball" >> $GITHUB_OUTPUT ;;
              10) echo "sport=tennis" >> $GITHUB_OUTPUT ;;
              15) echo "sport=hockey" >> $GITHUB_OUTPUT ;;
              20) echo "sport=volleyball" >> $GITHUB_OUTPUT ;;
              25) echo "sport=handball" >> $GITHUB_OUTPUT ;;
              *) echo "sport=football" >> $GITHUB_OUTPUT ;;
            esac
          fi
      
      - name: Set date
        id: set-date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

  scrape-football:
    needs: determine-sport
    if: needs.determine-sport.outputs.sport == 'football' || needs.determine-sport.outputs.sport == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 godzin dla 900+ meczÃ³w
    
    # ðŸ”¥ FlareSolverr Docker Service - omija Cloudflare!
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          TZ: Europe/Warsaw
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          # Chrome stability settings for CI/CD
          echo "CHROME_NO_SANDBOX=1" >> $GITHUB_ENV
          echo "DBUS_SESSION_BUS_ADDRESS=/dev/null" >> $GITHUB_ENV
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer Stealth
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
          # Biblioteki dla Puppeteer
          sudo apt-get install -y libatk-bridge2.0-0 libatk1.0-0 libcups2 libdrm2 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2 \
            libpango-1.0-0 libpangocairo-1.0-0 libnss3 libxss1 || true
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install xvfbwrapper
          # ðŸ”¥ Cloudflare Bypass packages
          pip install curl-cffi cloudscraper httpx[http2] || true
          playwright install firefox --with-deps || true
      
      - name: Wait for FlareSolverr
        run: |
          echo "â³ Waiting for FlareSolverr to be ready..."
          FLARESOLVERR_READY=false
          for i in {1..30}; do
            # SprawdÅº /health endpoint (zwraca JSON z statusem)
            if curl -s http://localhost:8191/health | grep -q '"status"'; then
              echo "âœ… FlareSolverr health endpoint responding!"
              # Weryfikacja - sprÃ³buj prostego request
              TEST_RESPONSE=$(curl -s -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"request.get","url":"https://www.google.com","maxTimeout":10000}' \
                --max-time 15 2>/dev/null || echo "TIMEOUT")
              if echo "$TEST_RESPONSE" | grep -q '"status":"ok"'; then
                echo "âœ… FlareSolverr verified - working correctly!"
                FLARESOLVERR_READY=true
                break
              else
                echo "âš ï¸ FlareSolverr health OK but test request not yet ready, retrying..."
              fi
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # Final status
          if [ "$FLARESOLVERR_READY" = "true" ]; then
            echo "ðŸŽ‰ FlareSolverr is fully operational!"
          else
            echo "âš ï¸ WARNING: FlareSolverr may not be fully ready!"
            echo "   Continuing anyway - code will handle fallback methods..."
          fi
      
      - name: Run Football Scraper
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_PROVIDER: ${{ secrets.EMAIL_PROVIDER || 'gmail' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python scrape_and_notify.py \
            --date ${{ needs.determine-sport.outputs.date }} \
            --sports football \
            --to "$EMAIL_TO" \
            --from-email "$EMAIL_FROM" \
            --password "$EMAIL_PASSWORD" \
            --provider "$EMAIL_PROVIDER" \
            --headless \
            --use-forebet \
            --use-sofascore \
            --use-odds
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: football-results-${{ needs.determine-sport.outputs.date }}
          path: |
            results/*.json
            results/*.csv
            results/*.html
            outputs/*.csv
          if-no-files-found: ignore
          retention-days: 30
      
      # ðŸ” Upload debug files for troubleshooting
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: football-debug-${{ needs.determine-sport.outputs.date }}
          path: |
            forebet_debug.html
            forebet_debug_rows.html
            forebet_*.html
            *.log
          if-no-files-found: ignore
          retention-days: 7

  scrape-basketball:
    needs: determine-sport
    if: needs.determine-sport.outputs.sport == 'basketball' || needs.determine-sport.outputs.sport == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 godzin
    
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          TZ: Europe/Warsaw
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          # Chrome stability settings for CI/CD
          echo "CHROME_NO_SANDBOX=1" >> $GITHUB_ENV
          echo "DBUS_SESSION_BUS_ADDRESS=/dev/null" >> $GITHUB_ENV
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer Stealth
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
          sudo apt-get install -y libatk-bridge2.0-0 libatk1.0-0 libcups2 libdrm2 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2 \
            libpango-1.0-0 libpangocairo-1.0-0 libnss3 libxss1 || true
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install xvfbwrapper
          # ðŸ”¥ Cloudflare Bypass packages
          pip install curl-cffi cloudscraper httpx[http2] || true
          playwright install firefox --with-deps || true
      
      - name: Wait for FlareSolverr
        run: |
          echo "â³ Waiting for FlareSolverr to be ready..."
          FLARESOLVERR_READY=false
          for i in {1..30}; do
            if curl -s http://localhost:8191/health | grep -q '"status"'; then
              echo "âœ… FlareSolverr health endpoint responding!"
              TEST_RESPONSE=$(curl -s -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"request.get","url":"https://www.google.com","maxTimeout":10000}' \
                --max-time 15 2>/dev/null || echo "TIMEOUT")
              if echo "$TEST_RESPONSE" | grep -q '"status":"ok"'; then
                echo "âœ… FlareSolverr verified - working correctly!"
                FLARESOLVERR_READY=true
                break
              fi
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          if [ "$FLARESOLVERR_READY" != "true" ]; then
            echo "âš ï¸ FlareSolverr may not be fully ready, continuing anyway..."
          fi
      
      - name: Run Basketball Scraper
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_PROVIDER: ${{ secrets.EMAIL_PROVIDER || 'gmail' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python scrape_and_notify.py \
            --date ${{ needs.determine-sport.outputs.date }} \
            --sports basketball \
            --to "$EMAIL_TO" \
            --from-email "$EMAIL_FROM" \
            --password "$EMAIL_PASSWORD" \
            --provider "$EMAIL_PROVIDER" \
            --headless \
            --use-forebet \
            --use-sofascore \
            --use-odds
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: basketball-results-${{ needs.determine-sport.outputs.date }}
          path: |
            results/*.json
            results/*.csv
            results/*.html
            outputs/*.csv
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: basketball-debug-${{ needs.determine-sport.outputs.date }}
          path: |
            forebet_debug.html
            forebet_debug_rows.html
            forebet_*.html
            *.log
          if-no-files-found: ignore
          retention-days: 7

  scrape-tennis:
    needs: determine-sport
    if: needs.determine-sport.outputs.sport == 'tennis' || needs.determine-sport.outputs.sport == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 godzin
    
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          TZ: Europe/Warsaw
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          # Chrome stability settings for CI/CD
          echo "CHROME_NO_SANDBOX=1" >> $GITHUB_ENV
          echo "DBUS_SESSION_BUS_ADDRESS=/dev/null" >> $GITHUB_ENV
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer Stealth
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
          sudo apt-get install -y libatk-bridge2.0-0 libatk1.0-0 libcups2 libdrm2 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2 \
            libpango-1.0-0 libpangocairo-1.0-0 libnss3 libxss1 || true
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install xvfbwrapper
          # ðŸ”¥ Cloudflare Bypass packages
          pip install curl-cffi cloudscraper httpx[http2] || true
          playwright install firefox --with-deps || true
      
      - name: Wait for FlareSolverr
        run: |
          echo "â³ Waiting for FlareSolverr to be ready..."
          FLARESOLVERR_READY=false
          for i in {1..30}; do
            if curl -s http://localhost:8191/health | grep -q '"status"'; then
              echo "âœ… FlareSolverr health endpoint responding!"
              TEST_RESPONSE=$(curl -s -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"request.get","url":"https://www.google.com","maxTimeout":10000}' \
                --max-time 15 2>/dev/null || echo "TIMEOUT")
              if echo "$TEST_RESPONSE" | grep -q '"status":"ok"'; then
                echo "âœ… FlareSolverr verified - working correctly!"
                FLARESOLVERR_READY=true
                break
              fi
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          if [ "$FLARESOLVERR_READY" != "true" ]; then
            echo "âš ï¸ FlareSolverr may not be fully ready, continuing anyway..."
          fi
      
      - name: Run Tennis Scraper
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_PROVIDER: ${{ secrets.EMAIL_PROVIDER || 'gmail' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python scrape_and_notify.py \
            --date ${{ needs.determine-sport.outputs.date }} \
            --sports tennis \
            --to "$EMAIL_TO" \
            --from-email "$EMAIL_FROM" \
            --password "$EMAIL_PASSWORD" \
            --provider "$EMAIL_PROVIDER" \
            --headless \
            --use-forebet \
            --use-sofascore \
            --use-odds
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tennis-results-${{ needs.determine-sport.outputs.date }}
          path: |
            results/*.json
            results/*.csv
            results/*.html
            outputs/*.csv
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tennis-debug-${{ needs.determine-sport.outputs.date }}
          path: |
            forebet_debug.html
            forebet_debug_rows.html
            forebet_*.html
            *.log
          if-no-files-found: ignore
          retention-days: 7

  scrape-hockey:
    needs: determine-sport
    if: needs.determine-sport.outputs.sport == 'hockey' || needs.determine-sport.outputs.sport == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 godzin
    
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          TZ: Europe/Warsaw
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          # Chrome stability settings for CI/CD
          echo "CHROME_NO_SANDBOX=1" >> $GITHUB_ENV
          echo "DBUS_SESSION_BUS_ADDRESS=/dev/null" >> $GITHUB_ENV
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer Stealth
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
          sudo apt-get install -y libatk-bridge2.0-0 libatk1.0-0 libcups2 libdrm2 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2 \
            libpango-1.0-0 libpangocairo-1.0-0 libnss3 libxss1 || true
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install xvfbwrapper
          # ðŸ”¥ Cloudflare Bypass packages
          pip install curl-cffi cloudscraper httpx[http2] || true
          playwright install firefox --with-deps || true
      
      - name: Wait for FlareSolverr
        run: |
          echo "â³ Waiting for FlareSolverr to be ready..."
          FLARESOLVERR_READY=false
          for i in {1..30}; do
            if curl -s http://localhost:8191/health | grep -q '"status"'; then
              echo "âœ… FlareSolverr health endpoint responding!"
              TEST_RESPONSE=$(curl -s -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"request.get","url":"https://www.google.com","maxTimeout":10000}' \
                --max-time 15 2>/dev/null || echo "TIMEOUT")
              if echo "$TEST_RESPONSE" | grep -q '"status":"ok"'; then
                echo "âœ… FlareSolverr verified - working correctly!"
                FLARESOLVERR_READY=true
                break
              fi
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          if [ "$FLARESOLVERR_READY" != "true" ]; then
            echo "âš ï¸ FlareSolverr may not be fully ready, continuing anyway..."
          fi
      
      - name: Run Hockey Scraper
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_PROVIDER: ${{ secrets.EMAIL_PROVIDER || 'gmail' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python scrape_and_notify.py \
            --date ${{ needs.determine-sport.outputs.date }} \
            --sports hockey \
            --to "$EMAIL_TO" \
            --from-email "$EMAIL_FROM" \
            --password "$EMAIL_PASSWORD" \
            --provider "$EMAIL_PROVIDER" \
            --headless \
            --use-forebet \
            --use-sofascore \
            --use-odds
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hockey-results-${{ needs.determine-sport.outputs.date }}
          path: |
            results/*.json
            results/*.csv
            results/*.html
            outputs/*.csv
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hockey-debug-${{ needs.determine-sport.outputs.date }}
          path: |
            forebet_debug.html
            forebet_debug_rows.html
            forebet_*.html
            *.log
          if-no-files-found: ignore
          retention-days: 7

  scrape-volleyball:
    needs: determine-sport
    if: needs.determine-sport.outputs.sport == 'volleyball' || needs.determine-sport.outputs.sport == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 godzin
    
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          TZ: Europe/Warsaw
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          # Chrome stability settings for CI/CD
          echo "CHROME_NO_SANDBOX=1" >> $GITHUB_ENV
          echo "DBUS_SESSION_BUS_ADDRESS=/dev/null" >> $GITHUB_ENV
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer Stealth
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
          sudo apt-get install -y libatk-bridge2.0-0 libatk1.0-0 libcups2 libdrm2 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2 \
            libpango-1.0-0 libpangocairo-1.0-0 libnss3 libxss1 || true
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install xvfbwrapper
          # ðŸ”¥ Cloudflare Bypass packages
          pip install curl-cffi cloudscraper httpx[http2] || true
          playwright install firefox --with-deps || true
      
      - name: Wait for FlareSolverr
        run: |
          echo "â³ Waiting for FlareSolverr to be ready..."
          FLARESOLVERR_READY=false
          for i in {1..30}; do
            if curl -s http://localhost:8191/health | grep -q '"status"'; then
              echo "âœ… FlareSolverr health endpoint responding!"
              TEST_RESPONSE=$(curl -s -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"request.get","url":"https://www.google.com","maxTimeout":10000}' \
                --max-time 15 2>/dev/null || echo "TIMEOUT")
              if echo "$TEST_RESPONSE" | grep -q '"status":"ok"'; then
                echo "âœ… FlareSolverr verified - working correctly!"
                FLARESOLVERR_READY=true
                break
              fi
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          if [ "$FLARESOLVERR_READY" != "true" ]; then
            echo "âš ï¸ FlareSolverr may not be fully ready, continuing anyway..."
          fi
      
      - name: Run Volleyball Scraper
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_PROVIDER: ${{ secrets.EMAIL_PROVIDER || 'gmail' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python scrape_and_notify.py \
            --date ${{ needs.determine-sport.outputs.date }} \
            --sports volleyball \
            --to "$EMAIL_TO" \
            --from-email "$EMAIL_FROM" \
            --password "$EMAIL_PASSWORD" \
            --provider "$EMAIL_PROVIDER" \
            --headless \
            --use-forebet \
            --use-sofascore \
            --use-odds
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: volleyball-results-${{ needs.determine-sport.outputs.date }}
          path: |
            results/*.json
            results/*.csv
            results/*.html
            outputs/*.csv
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: volleyball-debug-${{ needs.determine-sport.outputs.date }}
          path: |
            forebet_debug.html
            forebet_debug_rows.html
            forebet_*.html
            *.log
          if-no-files-found: ignore
          retention-days: 7

  scrape-handball:
    needs: determine-sport
    if: needs.determine-sport.outputs.sport == 'handball' || needs.determine-sport.outputs.sport == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 godzin
    
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          TZ: Europe/Warsaw
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          # Chrome stability settings for CI/CD
          echo "CHROME_NO_SANDBOX=1" >> $GITHUB_ENV
          echo "DBUS_SESSION_BUS_ADDRESS=/dev/null" >> $GITHUB_ENV
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Puppeteer Stealth
        run: |
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
          sudo apt-get install -y libatk-bridge2.0-0 libatk1.0-0 libcups2 libdrm2 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2 \
            libpango-1.0-0 libpangocairo-1.0-0 libnss3 libxss1 || true
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install xvfbwrapper
          # ðŸ”¥ Cloudflare Bypass packages
          pip install curl-cffi cloudscraper httpx[http2] || true
          playwright install firefox --with-deps || true
      
      - name: Wait for FlareSolverr
        run: |
          echo "â³ Waiting for FlareSolverr to be ready..."
          FLARESOLVERR_READY=false
          for i in {1..30}; do
            if curl -s http://localhost:8191/health | grep -q '"status"'; then
              echo "âœ… FlareSolverr health endpoint responding!"
              TEST_RESPONSE=$(curl -s -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"request.get","url":"https://www.google.com","maxTimeout":10000}' \
                --max-time 15 2>/dev/null || echo "TIMEOUT")
              if echo "$TEST_RESPONSE" | grep -q '"status":"ok"'; then
                echo "âœ… FlareSolverr verified - working correctly!"
                FLARESOLVERR_READY=true
                break
              fi
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          if [ "$FLARESOLVERR_READY" != "true" ]; then
            echo "âš ï¸ FlareSolverr may not be fully ready, continuing anyway..."
          fi
      
      - name: Run Handball Scraper
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_PROVIDER: ${{ secrets.EMAIL_PROVIDER || 'gmail' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python scrape_and_notify.py \
            --date ${{ needs.determine-sport.outputs.date }} \
            --sports handball \
            --to "$EMAIL_TO" \
            --from-email "$EMAIL_FROM" \
            --password "$EMAIL_PASSWORD" \
            --provider "$EMAIL_PROVIDER" \
            --headless \
            --use-forebet \
            --use-sofascore \
            --use-odds
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: handball-results-${{ needs.determine-sport.outputs.date }}
          path: |
            results/*.json
            results/*.csv
            results/*.html
            outputs/*.csv
          if-no-files-found: ignore
          retention-days: 30
      
      # ðŸ” Upload debug files for troubleshooting
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: handball-debug-${{ needs.determine-sport.outputs.date }}
          path: |
            forebet_debug.html
            forebet_debug_rows.html
            forebet_*.html
            *.log
          if-no-files-found: ignore
          retention-days: 7

  summary:
    needs: [scrape-football, scrape-basketball, scrape-tennis, scrape-hockey, scrape-volleyball, scrape-handball]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ† Daily Scraper Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "â° **Time:** $(date -u +%H:%M) UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sport Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Sport | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| âš½ Football | ${{ needs.scrape-football.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ€ Basketball | ${{ needs.scrape-basketball.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¾ Tennis | ${{ needs.scrape-tennis.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’ Hockey | ${{ needs.scrape-hockey.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Volleyball | ${{ needs.scrape-volleyball.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤¾ Handball | ${{ needs.scrape-handball.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # ðŸŽ¯ Weryfikacja wczorajszych predykcji
  verify-predictions:
    needs: [summary]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests supabase
      
      - name: Verify Yesterday's Predictions
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python auto_result_updater.py --date yesterday --mode check
      
      - name: Generate Accuracy Report
        run: |
          echo "## ðŸ“Š Prediction Accuracy Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Yesterday's predictions have been verified." >> $GITHUB_STEP_SUMMARY
          echo "Check Supabase dashboard for detailed stats." >> $GITHUB_STEP_SUMMARY

